# Development Environment

This is the environment that should be used primarily when developing.

## Features

`dev` provides following features:

| Feature | Description |
| :------ | :---------- |
| swappable containers | You can easily exchange docker containers with locally build/compiled services and integrate them to the other services for manual integration testing |
| runs service in `dev` mode | This means, that `vault` saved data in-memory and `consul` does not run at all. All other services are also run in development mode. |
| easy setup | `setup.sh` allows for fast creation of dummy data |

## Environment

| Variable | Content | Description |
| :------- | :------ | :---------- |
| `BUILD_ENV` | `dev` | Build environment. |
| `VAULT_HOST` | `127.0.0.1` | IP that vault socket uses. |
| `VAULT_PORT` | `5430` | Port that vault listens to. |
| `VAULT_TOKEN` | `root` | Development token. |
| `REVOLORI_HOST` | `127.0.0.1` | IP that revolori socket uses. |
| `REVOLORI_PORT` | `5429 # currently hard coded in revolori source code` | Port that revolori listens to. |
| `REVOLORI_HTTP_AUTH_USER` | `admin` | User for revolori's http authentication. |
| `REVOLORI_HTTP_AUTH_PASSWD` | `password` | Password for revolori's http authentication. |
| `OVERSEER_HOST` | `127.0.0.1` | IP that overseer socket uses. |
| `OVERSEER_PORT` | `5421` | Port that overseer listens to. |
| `OVERSEER_ADMIN` | `admin` | Admin user for overseer. |
| `OVERSEER_ADMIN_PASSWD` | `passwd` | Admin password for overseer. |
| `OVERSEER_USER` | `nick` | Technical user for overseer. |
| `OVERSEER_USER_PASSWD` | `passwd` | Technical user password for overseer. |
| `OVERSEER_DATABASE_URI` | `sqlite:////var/app-data/data.db` | Database that overseer uses, in this case SQLlite in-memory. |
| `CLOTILDE_HOST` | `127.0.0.1` | IP that clotilde socket uses. |
| `CLOTILDE_PORT` | `8080` | Port that coltilde listens to. |
| `CLOTILDE_BASE_URL` | `host.docker.internal` | Clotilde internal base url (needed).  |

If you want to configure these variables (it is strongly not recommended to configure `*_HOST` variables) you can copy the `.env` file to `custom.env`. You can now configure the file to your liking. Do not forget to specify it when using `docker-compose` like:

```
docker-compose --env-file custom.env up
```

## Prebuild Script

The prebuild script sets up all necessary secrets for the services to commincate to each other and save user data. See [Files](#files).

## Startup

Please checkout the general [README](../README.md) at `../README.md` on how to start the environment.


## Setup Script

The setup script creates the following two dummy users via `revolori`'s API, which can be used to login via `clotilde`'s frontend:

```
{
    "firstName": "Max",
    "lastName": "Mustermann",
    "password": "passwd",
    "email": "mm@example.com",
    "secondaryIDs": {
        "slack": [
            "mm1",
            "mm2"
        ]
    }
}

{
    "firstName": "Maria",
    "lastName": "Molewsko",
    "password": "passwd",
    "email": "maria@molewsko.com",
    "secondaryIDs": {
        "gitlab": [
            "mariamolewsko",
            "maria1299"
        ]
    }
}
```

The script also sets up dummy usage data for both users via `overseer`'s `/generate` endpoint, so you can see data accesses in `clotilde`'s frontend.

## Files

| File Name | Description |
| :-------- | :---------- |
| `./secrets/vault/ecdsa_key` | `[auto-generated by prebuild.sh]` ECDSA private key of `vault`. |
| `./secrets/vault/hmac` | `[auto-generated by prebuild.sh]` HMAC for `vault`. |
| `./secrets/vault/ecdsa_key.pub` | `[auto-generated by prebuild.sh]` Public key to verify `vault`'s integrity. |
| `./secrets/overseer/issuer.pub` | `[auto-generated by prebuild.sh]` Public key to verify `revolori`'s `vault` (same as `./secrets/vault/ecdsa_key.pub`). |
| `./data/overseer/data.db` | `[auto-generated by docker container]` `oversser`'s local SQLlite database. (Gets created when container is run). |
| `./configs/vault/config.json` | `vault`'s static configuration file setup to meet the environment variables set in `.env`. |

## Swapable containers

*The environment has to be set and started first.*

Following is an example of how to swap docker containers with locally build/compiled services. It is done with the `revolori` service.

First stop the service that you want to swap:

```
$ docker-compose stop revolori
```

Then rebuild the service and run it using the preset environment variables from `.env`:

```
$ cd ../../revolori-sso-provider 
$ go build
$ chmod +x revolori
$ ./revolori -vault-address "http://$VAULT_HOST:$VAULT_PORT" -vault-token "$VAULT_TOKEN" -auth-name "$REVOLORI_HTTP_AUTH_USER" -auth-password "$REVOLORI_HTTP_AUTH_PASSWD"
```
